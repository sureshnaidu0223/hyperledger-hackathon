# Hyperledger Fabric Client SDK for Node.js

## Overview

The Hyperledger Fabric Client SDK (HFC) provides a powerful and easy to use API to interact with a [Hyperledger Fabric](https://www.hyperledger.org/) blockchain from a Node.js application. It provides a set of APIs to register and enroll new network clients, to deploy new chaincodes to the network, and to interact with existing chaincodes through chaincode function invocations and queries.

To view the complete Node.js SDK documentation, additional usage samples, and getting started materials please visit the Hyperledger Fabric [SDK documentation page](http://hyperledger-fabric.readthedocs.io/en/latest/Setup/NodeSDK-setup/).

## Installation

If you are interfacing with a network running the Hyperledger Fabric `v0.5-developer-preview-1` branch, you must use the hfc version 0.5.3 release and install it with the following command:

    npm install -g hfc@0.5.3
    
For networks running a newer version of the Hyperledger Fabric, please install the latest available version of hfc, 0.6.x, with the following command:

    npm install -g hfc
    
## Usage

### Terminology

In order to transact on a Hyperledger blockchain, you must first have an identity which is both **registered** and **enrolled**. **Registration** means issuing a user invitation to join a blockchain network. **Enrollment** means accepting a user invitation to join a blockchain network. 

In the current Hyperleger Fabric implementation, the administative user admin is already registered on the network by the virtue of the fact that their user ID and password pair are already added to the membership services server confiruation file, [membersrvc.yaml](https://github.com/hyperledger/fabric/blob/master/membersrvc/membersrvc.yaml). Therefore, the admin user must only enroll to be able to transact on the network. After enrollment, the administrative user is then able to register and enroll new users, in the role of a registrar. New users are added to the network programmatically, through the HFC `chain.registerAndEnroll` API.

### Example

The following example demonstrates a typical web app. The application sets up a target for the membership service server and enrolls the admin user. Subsequently, the admin user is set as the registrar user and registers and enrolls a new member, JohnDoe. The new member, JohnDoe, is then able to transact on the blockchain by deploying a chaincode, invoking a chaincode function, and querying chaincode state.

Additional information on the example below as well as clarification on usage can be found [here](https://github.com/ratnakar-asara/NodeSdkSample).


``` js
// Include the package from npm:
var hfc = require('hfc');
//var hfc = require('../..');
var util = require('util');
var fs = require('fs');

// Create a client chain.
var chain = hfc.newChain("targetChain");

// Configure the KeyValStore which is used to store sensitive keys
// as so it is important to secure this storage.
// do a mkdir ~/tmp  (dont check if fails..just so it is there
chain.setKeyValStore(hfc.newFileKeyValStore('./keyValStore'));

chain.setMemberServicesUrl("grpc://localhost:50051");
var peer = chain.addPeer("grpc://localhost:30303");

var testChaincodeID;

// Enroll "admin" which is already registered because it is
// listed in fabric/membersrvc/membersrvc.yaml with it's one time password.
chain.enroll("admin", "Xurw3yU9zI0l", function(err, user1) {
    if (err) return console.log(util.format("ERROR: failed to register admin, Error : %j \n", err));
    // Set this user as the chain's registrar which is authorized to register other users.
    chain.setRegistrar(user1);

    console.log("\nEnrolled admin successfully\n");

    var userName = "JohnDoe";
        // registrationRequest
        var registrationRequest = {
            enrollmentID: userName,
            affiliation: "bank_a"
        };
        chain.registerAndEnroll(registrationRequest, function(err, user) {
            if (err) throw Error(" Failed to register and enroll " + userName + ": " + err);

            console.log("Enrolled %s successfully\n", userName);

            chain.setDeployWaitTime(60);
            chain.setInvokeWaitTime(10);
            deployChaincode(user);
        });
});

function deployChaincode(user) {
    console.log(util.format("Deploying chaincode ... It will take about %j seconds to deploy \n", chain.getDeployWaitTime()))
        // Construct the deploy request
    var deployRequest = {
        chaincodePath: "chaincode_example02",
        // Function to trigger
        fcn: "init",
        // Arguments to the initializing function
        args: ["a", "100", "b", "200"]
    };

    // Trigger the deploy transaction
    var deployTx = user.deploy(deployRequest);

    // Print the deploy results
    deployTx.on('complete', function(results) {
        // Deploy request completed successfully
        testChaincodeID = results.chaincodeID;
        console.log(util.format("[ Chaincode ID : ", testChaincodeID+" ]\n"));
        console.log(util.format("Successfully deployed chaincode: request=%j, response=%j \n", deployRequest, results));

        invokeOnUser(user);
    });
    deployTx.on('error', function(err) {
        // Deploy request failed
        console.log(util.format("Failed to deploy chaincode: request=%j, error=%j \n", deployRequest, err));
    });
}

function invokeOnUser(user) {
    // Construct the invoke request
    var invokeRequest = {
        // Name (hash) required for invoke
        chaincodeID: testChaincodeID,
        // Function to trigger
        fcn: "invoke",
        // Parameters for the invoke function
        args: ["a", "b", "1"]
    };

    // Trigger the invoke transaction
    var invokeTx = user.invoke(invokeRequest);

    invokeTx.on('submitted', function(results) {
        // Invoke transaction submitted successfully
        console.log(util.format("submitted chaincode invoke transaction: request=%j, response=%j\n", invokeRequest, results));
    });
    invokeTx.on('complete', function(results) {
        // Invoke transaction completed?
        console.log(util.format("completed chaincode invoke transaction: request=%j, response=%j\n", invokeRequest, results));
        queryUser(user);
    });
    invokeTx.on('error', function(err) {
        // Invoke transaction submission failed
        console.log(util.format("Failed to submit chaincode invoke transaction: request=%j, error=%j\n", invokeRequest, err));
    });
}

function queryUser(user) {
    // Construct the query request
    var queryRequest = {
        // Name (hash) required for query
        chaincodeID: testChaincodeID,
        // Function to trigger
        fcn: "query",
        // Existing state variable to retrieve
        args: ["a"]
    };

    // Trigger the query transaction
    var queryTx = user.query(queryRequest);

    queryTx.on('complete', function(results) {
        // Query completed successfully
        console.log("Successfully queried  chaincode function: request=%j, value=%s \n", queryRequest, results.result.toString());
    });
    queryTx.on('error', function(err) {
        // Query failed
        console.log("Failed to query chaincode, function: request=%j, error=%j \n", queryRequest, err);
    });
}
```

### Example For IBM Bluemix Blockchain Service

If you are specifically using the HFC with the IBM Bluemix Blockchain service, you can find another example [here](https://github.com/IBM-Blockchain/SDK-Demo/).

### Chaincode Deployment

Chaincode may be deployed in **development** mode or **network** mode. **Development** mode refers to running the chaincode as a stand alone process outside the network peer. This approach is useful while doing chaincode development and testing. The approach is described [here](https://github.com/hyperledger/fabric/blob/master/docs/Setup/Chaincode-setup.md). **Network** mode refers to packaging the chaincode and its dependencies and subsequently deploying the package to an existing network as a Docker container. To have the chaincode deployment with hfc succeed in network mode, you must properly set up the chaincode project and its dependencies. These instructions will demonstrate how to properly set up the directory structure to deploy [chaincode_example02.go](https://github.com/hyperledger/fabric/tree/master/examples/chaincode/go/chaincode_example02) project in network mode.

The chaincode project must be placed inside the `src` directory in your local `$GOPATH`. For example, the `chaincode_example02` project may be placed inside `$GOPATH/src/` as shown below.

```
$GOPATH/src/github.com/chaincode_example02/
```

After you have placed your chaincode project under the `$GOPATH/src/`, you will need to vendor the dependencies. From the directory containing your chaincode source, run the following commands:

```
go get -u github.com/kardianos/govendor
cd $GOPATH/src/github.com/chaincode_example02
govendor init
govendor fetch github.com/hyperledger/fabric
```

Currently, the Hyperledger Fabric source tree is a dependency and must be present inside the `vendor` folder for the chaincode project to build and deploy successfully on the peer. We are currently working to remove this dependency to simplify the deployment process. The resulting project directory structure is shown below.

```
ls -la $GOPATH/src/github.com/chaincode_example02/
.
..
chaincode_example02.go
vendor

ls -la $GOPATH/src/github.com/chaincode_example02/vendor/github.com/hyperledger/
.
..
fabric
```

Once you have placed your chaincode project inside the `src` directory in your local `$GOPATH` together with the `vendor` directory containing the Hyperledger Fabric, you need to verify that the chaincode builds in this directory. To do so execute `go build`. This step verifies that all of the chaincode dependencies are present.

```
cd $GOPATH/src/github.com/chaincode_example02/
go build
```

Additional information regarding structuring your chaincode directories for deployment can be found [here](https://github.com/hyperledger/fabric/blob/master/docs/nodeSDK/node-sdk-indepth.md#chaincode-deployment).

### Enabling TLS

If you wish to enable TLS connection with the member services the following actions are needed:

- Modify `$GOPATH/src/github.com/hyperledger/fabric/membersrvc/membersrvc.yaml` as follows:

```
server:
     tls:
        certfile: "/var/hyperledger/production/.membersrvc/tlsca.cert"
        keyfile: "/var/hyperledger/production/.membersrvc/tlsca.priv"
```

This is needed to instruct the member services server on which tls cert and key to use.  

- Modify `$GOPATH/src/github.com/hyperledger/fabric/peer/core.yaml` as follows:

```
peer:
    pki:
        tls:
            enabled: true
            rootcert:
                file: "/var/hyperledger/production/.membersrvc/tlsca.cert"
```

This is needed to allow the peer to connect to the member services server using TLS, otherwise the connection will fail.

- Bootstrap your member services and the peer. This is needed in order to have the file *tlsca.cert* generated by the member services.

- Copy `/var/hyperledger/production/.membersrvc/tlsca.cert` to `$GOPATH/src/github.com/hyperledger/fabric/sdk/node`.

*Note:* If you cleanup the folder `/var/hyperledger/production` directory, then don't forget to again copy the *tlsca.cert* file as described above.

Additional information regarding enabling TLS for the SDK can be found [here](https://github.com/hyperledger/fabric/blob/master/docs/nodeSDK/node-sdk-indepth.md#enabling-tls).

## Objects, Classes, And Interfaces

HFC is written primarily in Typescript and is object-oriented. The source can be found in the [fabric/sdk/node](https://github.com/hyperledger/fabric/tree/master/sdk/node) directory of the Hyperledger Fabric project. You can view the reference documentation in your browser by opening the [reference documentation](doc/modules/_src_hfc_.html) and clicking on **"hfc"** on the right-hand side under **"Globals"**.

The following is a high-level description of the HFC objects (classes and interfaces) to help guide you through the object hierarchy.

* The top-level class is [Chain](doc/classes/_src_hfc_.chain.html). It is the client's representation of a chain. HFC allows you to interact with multiple chains and to share a single [KeyValStore](doc/interfaces/_src_hfc_.keyvalstore.html) and [MemberServices](doc/interfaces/_src_hfc_.memberservices.html) objects with multiple Chain objects as needed. For each chain, you add one or more [Peer](doc/classes/_src_hfc_.peer.html) objects which represent an endpoint to which HFC connects to transact on the chain.

* The [KeyValStore](doc/interfaces/_src_hfc_.keyvalstore.html) is a very simple interface which HFC uses to store and retrieve all persistent data. This data includes private keys, so it is very important to keep this storage secure. The default is a simple file-based implementation.

* The [MemberServices](doc/interfaces/_src_hfc_.memberservices.html) interface provides security and identity related features such as privacy, unlinkability, and confidentiality. This implementation issues **ECerts** (enrollment certificates) and **TCerts** (transaction certificates).  ECerts are for enrollment identity and TCerts are for transactions.

* The [Member](doc/classes/_src_hfc_.member.html) class most often represents an end user who transacts on the chain, but it may also represent other types of members such as peers. From the Member class, you can **register** and **enroll** members or users. This interacts with the [MemberServices](doc/interfaces/_src_hfc_.memberservices.html) object. You can also deploy, query, and invoke chaincode directly, which interacts with the [Peer](doc/classes/_src_hfc_.peer.html). The implementation for deploy, query and invoke creates a temporary [TransactionContext](doc/classes/_src_hfc_.transactioncontext.html) object and delegates the work to it.

* The [TransactionContext](doc/classes/_src_hfc_.transactioncontext.html) class implements the bulk of the deploy, invoke, and query logic. It interacts with MemberServices to get a TCert to perform these operations.  Note, that there is a one-to-one relationship between TCert and TransactionContext. In other words, a single TransactionContext will always use the same TCert. If you want to issue multiple transactions with the same TCert, then you can get a [TransactionContext](doc/classes/_src_hfc_.transactioncontext.html) object from a [Member](doc/classes/_src_hfc_.member.html) object directly and issue multiple deploy, invoke, or query operations on it. However if you do this, these transactions are linkable, which means someone could tell that they came from the same user, though not know which user. For this reason, you will typically just call deploy, invoke, and query on the User or Member object.

## Unit Tests

HFC includes a set of unit tests implemented with the [tape framework](https://github.com/substack/tape). Currently, the unit tests are designed to run inside the Hyperledger Fabric Vagrant development environment. To run the unit tests, first set up the Hyperledger Fabric Vagrant development environment per the instructions [here](http://hyperledger-fabric.readthedocs.io/en/latest/dev-setup/devenv/). 

Launch the Vagrant VM and log into the VM by executing the following command:

    vagrant ssh

Run the unit tests within the Vagrant environment with the following commands:

    cd $GOPATH/src/github.com/hyperledger/fabric
    make node-sdk-unit-tests

The following are brief descriptions of each of the unit tests that are being run.

#### registrar

The [registrar.js](https://github.com/hyperledger/fabric/blob/master/sdk/node/test/unit/registrar.js) test case exercises registering users with the membership services server. It also tests registering a designated registrar user which can then register additional users.

#### chain-tests

The [chain-tests.js](https://github.com/hyperledger/fabric/blob/master/sdk/node/test/unit/chain-tests.js) test case exercises the [chaincode_example02.go](https://github.com/hyperledger/fabric/tree/master/examples/chaincode/go/chaincode_example02) chaincode when it has been deployed in both development mode and network mode.

#### asset-mgmt

The [asset-mgmt.js](https://github.com/hyperledger/fabric/blob/master/sdk/node/test/unit/asset-mgmt.js) test case exercises the [asset_management.go](https://github.com/hyperledger/fabric/tree/master/examples/chaincode/go/asset_management) chaincode when it has been deployed in both development mode and network mode.

#### asset-mgmt-with-roles

The [asset-mgmt-with-roles.js](https://github.com/hyperledger/fabric/blob/master/sdk/node/test/unit/asset-mgmt-with-roles.js) test case exercises the [asset_management_with_roles.go](https://github.com/hyperledger/fabric/tree/master/examples/chaincode/go/asset_management_with_roles) chaincode when it has been deployed in both development mode and network mode.

## Basic Troubleshooting

Keep in mind that you can perform the enrollment process with the membership services server only once, as the enrollmentSecret is a one-time-use password. If you have performed a user registration/enrollment with the membership services and subsequently deleted the crypto tokens stored on the client side, the next time you try to enroll, errors similar to the ones below will be seen.

   ```
   Error: identity or token do not match
   ```
   ```
   Error: user is already registered
   ```

To address this, remove any stored crypto material from the CA server by following the instructions [here](https://github.com/hyperledger/fabric/blob/master/docs/Setup/Chaincode-setup.md#removing-temporary-files-when-security-is-enabled). You will also need to remove any of the crypto tokens stored on the client side by deleting the KeyValStore directory. That directory is configurable and is set to `/tmp/keyValStore` within the unit tests.

## Support

We use [Hyperledger Slack](https://hyperledgerproject.slack.com/) for communication regarding the SDK and any potential issues. Please join SDK related channels on Slack such as #fabric-sdk and #nodesdk. If you would like to file a bug report or submit a request for a feature please do so on Jira [here](https://jira.hyperledger.org).

## Contributing

We welcome any contributions to the Hyperledger Fabric Node.js SDK project. If you would like to contribute please read the contribution guidelines [here](http://hyperledger-fabric.readthedocs.io/en/latest/CONTRIBUTING/) for more information.

## License

Contributed to the Hyperledger Project under the [Apache Software License 2.0](https://github.com/hyperledger/fabric/blob/master/LICENSE).
